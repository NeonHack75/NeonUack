-- ═══════════════════════════════════════════════════════════════
--           MEGA MM2 ULTRA HUB v5.0 | С БИБЛИОТЕКОЙ RAYFIELD
--                   Полный контроль над MM2
-- ═══════════════════════════════════════════════════════════════

-- Загрузка библиотеки Rayfield (лучшая GUI-библиотека)
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

-- Окно
local Window = Rayfield:CreateWindow({
    Name = "MEGA MM2 ULTRA HUB v5.0",
    LoadingTitle = "Загрузка читов...",
    LoadingSubtitle = "by [Твой ник]",
    ConfigurationSaving = {Enabled = true, FolderName = "MM2HubConfig"},
    Discord = {Enabled = false},
    KeySystem = false
})

-- Вкладки
local MainTab = Window:CreateTab("Главная", 4483362458)
local CombatTab = Window:CreateTab("Бой", 4483362458)
local VisualTab = Window:CreateTab("Визуал", 4483362458)
local UtilityTab = Window:CreateTab("Утилиты", 4483362458)
local FarmTab = Window:CreateTab("Фарм", 4483362458)
local MiscTab = Window:CreateTab("Прочее", 4483362458)

-- === ПЕРЕМЕННЫЕ ===
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local LocalPlayer = Players.LocalPlayer
local Camera = Workspace.CurrentCamera
local Mouse = LocalPlayer:GetMouse()

getgenv().MM2 = {
    ESP = {Enabled = false},
    Aimbot = {Enabled = false, FOV = 100, Smooth = 0.2, Bone = "Head"},
    KillAura = {Enabled = false, Range = 20},
    GodMode = false,
    Speed = 16,
    FlySpeed = 100,
    NoClip = false,
    AutoFarm = {Coins = false, Gems = false},
    Role = "Innocent"
}

-- === МОДУЛЬ ESP (с библиотекой Drawing) ===
local ESP = {}
ESP.Drawings = {}

local function CreateBox()
    local box = Drawing.new("Square")
    box.Thickness = 2
    box.Filled = false
    box.Transparency = 1
    return box
end

local function CreateText()
    local text = Drawing.new("Text")
    text.Size = 14
    text.Center = true
    text.Outline = true
    text.Font = 2
    return text
end

local function AddESP(player)
    if player == LocalPlayer then return end
    local box = CreateBox()
    local name = CreateText()
    local role = CreateText()
    local dist = CreateText()

    ESP.Drawings[player] = {Box = box, Name = name, Role = role, Dist = dist}
end

for _, p in pairs(Players:GetPlayers()) do AddESP(p) end
Players.PlayerAdded:Connect(AddESP)

-- === ОБНОВЛЕНИЕ ESP ===
RunService.RenderStepped:Connect(function()
    if not getgenv().MM2.ESP.Enabled then
        for _, v in pairs(ESP.Drawings) do
            v.Box.Visible = false
            v.Name.Visible = false
            v.Role.Visible = false
            v.Dist.Visible = false
        end
        return
    end

    for player, drawings in pairs(ESP.Drawings) do
        if player.Character and player.Character:FindFirstChild("HumanoidRootPart") and player.Character:FindFirstChild("Head") then
            local root = player.Character.HumanoidRootPart
            local head = player.Character.Head
            local hum = player.Character:FindFirstChild("Humanoid")
            local vec, onScreen = Camera:WorldToViewportPoint(root.Position)

            if onScreen and hum and hum.Health > 0 then
                local scale = 1000 / vec.Z
                local size = Vector2.new(scale * 2.5, scale * 4)

                -- Роль
                local role = "Innocent"
                local color = Color3.fromRGB(0, 255, 0)
                if player.Backpack:FindFirstChild("Knife") or (player.Character and player.Character:FindFirstChild("Knife")) then
                    role = "Murderer"
                    color = Color3.fromRGB(255, 0, 0)
                elseif player.Backpack:FindFirstChild("Gun") or (player.Character and player.Character:FindFirstChild("Gun")) then
                    role = "Sheriff"
                    color = Color3.fromRGB(0, 100, 255)
                end

                drawings.Box.Size = size
                drawings.Box.Position = Vector2.new(vec.X - size.X/2, vec.Y - size.Y/2)
                drawings.Box.Color = color
                drawings.Box.Visible = true

                drawings.Name.Text = player.Name
                drawings.Name.Position = Vector2.new(vec.X, vec.Y - size.Y/2 - 20)
                drawings.Name.Color = Color3.fromRGB(255, 255, 255)
                drawings.Name.Visible = true

                drawings.Role.Text = role
                drawings.Role.Position = Vector2.new(vec.X, vec.Y - size.Y/2 - 5)
                drawings.Role.Color = color
                drawings.Role.Visible = true

                drawings.Dist.Text = math.floor((LocalPlayer.Character.HumanoidRootPart.Position - root.Position).Magnitude) .. "m"
                drawings.Dist.Position = Vector2.new(vec.X, vec.Y + size.Y/2 + 5)
                drawings.Dist.Color = Color3.fromRGB(200, 200, 200)
                drawings.Dist.Visible = true
            else
                for _, v in pairs(drawings) do v.Visible = false end
            end
        else
            for _, v in pairs(drawings) do v.Visible = false end
        end
    end
end)

-- === AIMBOT ===
local function GetClosest()
    local closest, dist = nil, getgenv().MM2.Aimbot.FOV
    for _, p in pairs(Players:GetPlayers()) do
        if p ~= LocalPlayer and p.Character and p.Character:FindFirstChild("HumanoidRootPart") and p.Character:FindFirstChild("Humanoid") and p.Character.Humanoid.Health > 0 then
            local root = p.Character.HumanoidRootPart
            local bone = p.Character:FindFirstChild(getgenv().MM2.Aimbot.Bone) or root
            local screenPos, onScreen = Camera:WorldToViewportPoint(bone.Position)
            local mousePos = Vector2.new(Mouse.X, Mouse.Y)
            local d = (screenPos - mousePos).Magnitude
            if onScreen and d < dist then
                closest = bone
                dist = d
            end
        end
    end
    return closest
end

RunService.RenderStepped:Connect(function()
    if getgenv().MM2.Aimbot.Enabled and Mouse.Target then
        local target = GetClosest()
        if target then
            local pos = Camera:WorldToViewportPoint(target.Position)
            mousemoverel((pos.X - Mouse.X) * getgenv().MM2.Aimbot.Smooth, (pos.Y - Mouse.Y) * getgenv().MM2.Aimbot.Smooth)
        end
    end
end)

-- === KILL AURA ===
spawn(function()
    while wait(getgenv().MM2.KillAura.Delay or 0.1) do
        if getgenv().MM2.KillAura.Enabled and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
            for _, p in pairs(Players:GetPlayers()) do
                if p ~= LocalPlayer and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
                    local dist = (LocalPlayer.Character.HumanoidRootPart.Position - p.Character.HumanoidRootPart.Position).Magnitude
                    if dist <= getgenv().MM2.KillAura.Range then
                        local knife = LocalPlayer.Character:FindFirstChild("Knife") or LocalPlayer.Backpack:FindFirstChild("Knife")
                        if knife then
                            knife.Parent = LocalPlayer.Character
                            knife:Activate()
                        end
                    end
                end
            end
        end
    end
end)

-- === GOD MODE ===
MainTab:CreateToggle({
    Name = "God Mode",
    CurrentValue = false,
    Callback = function(v)
        getgenv().MM2.GodMode = v
        if v then
            LocalPlayer.Character.Humanoid.WalkSpeed = 16
            LocalPlayer.Character.Humanoid:TakeDamage(0)
            LocalPlayer.Character.Humanoid.Health = 100
            LocalPlayer.Character.Humanoid.MaxHealth = 99999
        end
    end
})

-- === SPEED HACK ===
MainTab:CreateSlider({
    Name = "Скорость",
    Range = {16, 300},
    Increment = 1,
    CurrentValue = 16,
    Callback = function(v)
        getgenv().MM2.Speed = v
        LocalPlayer.Character.Humanoid.WalkSpeed = v
    end
})

-- === FLY ===
local flying = false
MainTab:CreateToggle({
    Name = "Fly (F)",
    CurrentValue = false,
    Callback = function(v)
        flying = v
        if v then
            local body = Instance.new("BodyVelocity")
            body.Velocity = Vector3.new(0,0,0)
            body.MaxForce = Vector3.new(1e5,1e5,1e5)
            body.Parent = LocalPlayer.Character.HumanoidRootPart
            spawn(function()
                while flying and wait() do
                    local cam = Camera.CFrame
                    LocalPlayer.Character.HumanoidRootPart.Velocity = (cam.LookVector * UserInputService:IsKeyDown(Enum.KeyCode.W) and getgenv().MM2.FlySpeed or 0)
                    + (cam.LookVector * UserInputService:IsKeyDown(Enum.KeyCode.S) and -getgenv().MM2.FlySpeed or 0)
                    + (cam.UpVector * UserInputService:IsKeyDown(Enum.KeyCode.Space) and getgenv().MM2.FlySpeed or 0)
                    + (cam.UpVector * UserInputService:IsKeyDown(Enum.KeyCode.LeftShift) and -getgenv().MM2.FlySpeed or 0)
                end
            end)
        end
    end
})

-- === NOCLIP ===
MainTab:CreateToggle({
    Name = "NoClip",
    CurrentValue = false,
    Callback = function(v)
        getgenv().MM2.NoClip = v
        for _, part in pairs(LocalPlayer.Character:GetDescendants()) do
            if part:IsA("BasePart") then
                part.CanCollide = not v
            end
        end
    end
})

-- === ESP TOGGLE ===
VisualTab:CreateToggle({
    Name = "ESP",
    CurrentValue = true,
    Callback = function(v) getgenv().MM2.ESP.Enabled = v end
})

-- === AIMBOT TOGGLE ===
CombatTab:CreateToggle({
    Name = "Aimbot",
    CurrentValue = false,
    Callback = function(v) getgenv().MM2.Aimbot.Enabled = v end
})

-- === KILL AURA ===
CombatTab:CreateToggle({
    Name = "Kill Aura",
    CurrentValue = false,
    Callback = function(v) getgenv().MM2.KillAura.Enabled = v end
})

-- === AUTO FARM COINS ===
FarmTab:CreateToggle({
    Name = "Auto Farm Coins",
    CurrentValue = false,
    Callback = function(v)
        getgenv().MM2.AutoFarm.Coins = v
        if v then
            spawn(function()
                while getgenv().MM2.AutoFarm.Coins and wait(0.5) do
                    for _, coin in pairs(Workspace:GetDescendants()) do
                        if coin.Name == "Coin_Server" then
                            LocalPlayer.Character.HumanoidRootPart.CFrame = coin.CFrame
                            wait(0.1)
                        end
                    end
                end
            end)
        end
    end
})

-- === ROLE CHANGER (Fake) ===
MiscTab:CreateButton({
    Name = "Стать убийцей (Fake)",
    Callback = function()
        local knife = Instance.new("Tool")
        knife.Name = "Knife"
        knife.Parent = LocalPlayer.Backpack
        Rayfield:Notify({Title="Role Changer", Content="Ты теперь 'убийца' (визуально)", Duration=3})
    end
})

-- === SERVER HOP ===
MiscTab:CreateButton({
    Name = "Server Hop",
    Callback = function()
        local servers = game.HttpGet("https://games.roblox.com/v1/games/"..game.PlaceId.."/servers/Public?sortOrder=Asc&limit=100")
        local data = game:GetService("HttpService"):JSONDecode(servers)
        for _, v in pairs(data.data) do
            if v.playing < v.maxPlayers then
                game:GetService("TeleportService"):TeleportToPlaceInstance(game.PlaceId, v.id)
                break
            end
        end
    end
})

-- === УВЕДОМЛЕНИЕ ===
Rayfield:Notify({
    Title = "MEGA MM2 ULTRA HUB",
    Content = "Загружено успешно! Наслаждайся доминированием.",
    Duration = 5,
    Image = 4483362458
})
